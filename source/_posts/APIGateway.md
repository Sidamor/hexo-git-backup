---
title: APIGateway
date: 2019-08-07 10:24:04
categories: 
- MicroService
tags:
- MicroService
- API网关
- 单点登陆
- 功能权限
- 数据权限
---

# 私有云api网关

情景：
* 私有云，对外提供服务，包括原生服务、第三方服务
* 统一账号管理(支持单点登陆），私有云之外的服务也可以享受账号体系、单点登陆
* 私有云里的服务，可到权限中心认证接口调用权限
* 私有云之外的服务，可通过API网关认证接口调用权限

<!--more-->

## api网关结构设计

如图1，我们看一下网上的一个还不错的架构图。简单解释一下。

* OpenResty Api Gateway
从左至右 HTTP 请求先由DNS在拿到第一手流量后负载均衡到基于 OpenResty 的 API Gataway 网关集群，在这个流程我们可以使用像 Kong,Orage,Tyk 这些开源的支持高并发高访问量 API 网关程序在做第一层流量的防护，在这一级我们可以做一些像身份认证，安全，监控，日志，流控等策略。除了这些我们还可以做一些服务的发现和注册（这个要看不同网关的支持程度），接口的版本控制，路由重写等。

* Aggr Api Gateway
然后再由这些 API 网关把请求再负载到不同的 Aggr Api Gateway，在这里我们做聚合服务这个操作，具体体现也就是图中的黄色区域是需要由各个语言的开发人员来需要写代码实现的。具体流程也就是我们可以引入像 Ocelot 这种和语言相关的 API 网关开源项目，然后通过 NuGet 包引入之后通过 Json配置+聚合代码的方式来整合后端的各个微服务提供聚合查询等操作。这期间对于有需求的接口，我们可以应用超时，缓存，熔断，重试等策略。

从 Aggr Api Gateway 到后端微服务集群这中间就属于内部的通讯了，我们可以使用对内部友好的通讯协议比如 gRPC 或者 AMQP 等，然后进行 RPC调用提高通讯性能。

注意：Aggr Api Gateway 这个网关对于一些接口来说的话并不是必须的，也可以由后端微服务直接提供REST API给第一层网关使用。

![图1](图1.png)

结合之前描述的应用情景，加入我们需要的一些用户、权限模块，如图2所示

![图2](图2.png)

## API网关

1. 所有服务注册（不论集群内部还是外部），api网关提供（权限中心）接口发放appKey&appSecret
2. k8s内的服务间调用，采用k8s自带的监控体系
3. k8s外服务调用私有云的服务，通过api网关进行调用监控


## 用户中心（支持OpenLDAP）和单点登陆

1. 所有用户进行统一账号管理
2. 所有登陆请求统一由API网关向外提供单点登陆服务


## 权限中心

1. 用户发起调用鉴权：用户通过登陆获取token（短期）用于鉴权

* k8s内的服务被调用，自行到权限中心进行鉴权
* k8s外的服务被调用，向api网关发起鉴权请求


2. 服务发起调用鉴权：服务通过appKey&appSecret获取token（长期）用于鉴权

* k8s内的服务被调用，自行到权限中心进行鉴权
* k8s外的服务被调用，向api网关发起鉴权请求




